import{isSpace as b}from"markdown-it/lib/common/utils.mjs";const k=46,w=35,E=32,v=61,R=34,S=e=>!(e===9||e===10||e===12||e===32||e===47||e===62||e===34||e===39||e===61),O=(e,t,n)=>{let l="",r="",o=!0,s=!1;const i=[];for(let c=t[0];c<t[1];c++){const a=e.charCodeAt(c);if(a===v&&o){o=!1;continue}if(a===k&&l===""){e.charCodeAt(c+1)===k?(l="css-module",c++):l="class",o=!1;continue}if(a===w&&l===""){l="id",o=!1;continue}if(a===R&&r===""&&!s){s=!0;continue}if(a===R&&s){s=!1;continue}if(a===E&&!s){if(l==="")continue;i.push([l,r]),l="",r="",o=!0;continue}if(!(o&&!S(a))){if(o){l+=String.fromCharCode(a);continue}r+=String.fromCharCode(a)}}return l!==""&&i.push([l,r]),n.length?i.filter(([c])=>n.some(a=>a instanceof RegExp?a.test(c):a===c)):i},p=(e,t,n,l)=>{e&&O(t,n,l).forEach(([r,o])=>{switch(r){case"class":e.attrJoin("class",o);break;case"css-module":e.attrJoin("css-module",o);break;default:e.attrPush([r,o])}})},d=({left:e,right:t},n)=>{if(!["start","end","only"].includes(n))throw new Error(`Invalid 'where' parameter: ${n}. Expected 'start', 'end', or 'only'.`);const l=e.length,r=t.length,o=l+1+r;return s=>{if(typeof s!="string"||s.length<o)return!1;let i,c;if(n==="start"){if(!s.startsWith(e)||(i=l,c=s.indexOf(t,l+1),c===-1))return!1;const u=c+r;if(u<s.length&&t.includes(s.charAt(u)))return!1}else if(n==="end"){if(i=s.lastIndexOf(e),i===-1||(c=s.indexOf(t,i+l+1),i+=l,c===-1||c+r!==s.length))return!1}else{if(!s.startsWith(e)||!s.endsWith(t))return!1;i=l,c=s.length-r}const a=s.charCodeAt(i),h=c-i;return(a===k||a===w?h>=2:h>=1)?[i,c]:!1}},g=(e,t)=>{const n=e[t];if(n.type==="softbreak")return null;if(n.nesting===0)return n;const l=n.level,r=n.type.replace("_close","_open");for(;t>=0;){const o=e[t];if(o.type===r&&o.level===l)return o;t--}/* istanbul ignore next -- @preserve */return null},T=(e,t)=>t>=0?e[t]:e[e.length+t],A=(e,t,n)=>{const l={match:!1,position:null,range:null},r=n.shift!==void 0,o=r?t+n.shift:n.position;if(r&&o<0)return l;const s=T(e,o);if(!s)return l;for(const i of Object.keys(n)){if(i==="shift"||i==="position")continue;if(s[i]==null)return l;if(i==="children"&&Array.isArray(n.children)){if(!s.children?.length)return l;const a=n.children,h=s.children;let u,y=null;if(a.every(f=>f.position!=null)){if(u=a.every(f=>{const m=A(h,f.position,f);return m.match?(m.range&&(y=m.range),!0):!1}),u){const{position:f}=a[a.length-1];l.position=f>=0?f:h.length+f,l.range=y}}else for(let f=0;f<h.length;f++)if(u=a.every(m=>{const _=A(h,f,m);return _.match?(_.range&&(y=_.range),!0):!1}),u){l.position=f,y&&(l.range=y);break}if(u===!1)return l;continue}const c=n[i];switch(typeof c){case"boolean":case"number":case"string":{if(s[i]!==c)return l;break}case"function":{const a=c(s[i]);if(!a)return l;Array.isArray(a)&&(l.range=a);break}default:throw new Error(`Unknown type of pattern test (key: ${i}). Test should be of type boolean, number, string or function.`)}}return l.match=!0,l},I=e=>({name:"end of block",tests:[{shift:0,type:"inline",children:[{position:-1,content:d(e,"end"),type:t=>t!=="code_inline"&&t!=="math_inline"}]}],transform:(t,n,l,r)=>{const o=r[0]-e.left.length,s=t[n].children[l],{content:i}=s,c=b(i.charCodeAt(o-1));let a=n+1;for(;t[a+1]?.nesting===-1;)a++;const h=g(t,a);p(h,i,r,e.allowed),s.content=i.slice(0,c?o-1:o)}}),M=e=>({name:"code-block",tests:[{shift:0,block:!0,info:d(e,"end")}],transform:(t,n,l,r)=>{const o=r[0]-e.left.length,s=t[n],{info:i}=s,c=b(i.charCodeAt(o-1));p(s,i,r,e.allowed),s.info=i.slice(0,c?o-1:o)}}),K=e=>({name:"end of block",tests:[{shift:-1,type:"heading_open"},{shift:0,type:"inline",children:[{position:-1,content:d(e,"end"),type:t=>t!=="code_inline"&&t!=="math_inline"}]}],transform:(t,n,l,r)=>{const o=r[0]-e.left.length,s=t[n].children[l],{content:i}=s,c=b(i.charCodeAt(o-1)),a=g(t,n+1);p(a,i,r,e.allowed),s.content=i.slice(0,c?o-1:o)}}),P=e=>[{name:"inline nesting self-close",tests:[{shift:0,type:"inline",children:[{shift:-1,type:t=>t==="image"||t==="code_inline"},{shift:0,type:"text",content:d(e,"start")}]}],transform:(t,n,l,r)=>{const o=t[n].children,s=o[l],i=o[l-1],c=e.right.length+r[1];p(i,s.content,r,e.allowed),s.content.length===c?o.splice(l,1):s.content=s.content.slice(c)}},{name:"inline attributes",tests:[{shift:0,type:"inline",children:[{shift:-1,nesting:-1},{shift:0,type:"text",content:d(e,"start")}]}],transform:(t,n,l,r)=>{const o=t[n].children,s=o[l],{content:i}=s,c=e.right.length+r[1],a=g(o,l-1);p(a,i,r,e.allowed),s.content=i.slice(c)}}],W=e=>[{name:"list softbreak",tests:[{shift:-2,type:"list_item_open"},{shift:0,type:"inline",children:[{position:-2,type:"softbreak"},{position:-1,type:"text",content:d(e,"only")}]}],transform:(t,n,l,r)=>{const o=t[n].children,s=o[l];let i=n-2;for(;t[i-1]?.type!=="ordered_list_open"&&t[i-1].type!=="bullet_list_open";)i--;p(t[i-1],s.content,r,e.allowed),t[n].children=o.slice(0,-2)}},{name:"list double softbreak",tests:[{shift:0,type:t=>t==="bullet_list_close"||t==="ordered_list_close"},{shift:1,type:"paragraph_open"},{shift:2,type:"inline",content:d(e,"only"),children:t=>t.length===1},{shift:3,type:"paragraph_close"}],transform:(t,n,l,r)=>{const o=t[n+2],s=g(t,n);p(s,o.content,r,e.allowed),t.splice(n+1,3)}},{name:"list item end",tests:[{shift:-2,type:"list_item_open"},{shift:0,type:"inline",children:[{position:-1,type:"text",content:d(e,"end")}]}],transform:(t,n,l,r)=>{const o=t[n].children[l],{content:s}=o,i=r[0]-e.left.length,c=b(s.charCodeAt(i-1));p(t[n-2],s,r,e.allowed),o.content=s.slice(0,c?i-1:i)}}],B=e=>({name:`
{.a} softbreak then curly in start`,tests:[{shift:0,type:"inline",children:[{position:-2,type:"softbreak"},{position:-1,type:"text",content:d(e,"only")}]}],transform:(t,n,l,r)=>{const o=t[n].children,s=o[l];let i=n+1;for(;t[i+1]?.nesting===-1;)i++;p(g(t,i),s.content,r,e.allowed),t[n].children=o.slice(0,-2)}}),D=e=>({name:"horizontal rule",tests:[{shift:0,type:"paragraph_open"},{shift:1,type:"inline",children:t=>t.length===1,content:t=>{let n=0,l;const r=t.charCodeAt(n++);if(r!==45&&r!==42&&r!==95)return!1;let o=1;for(;n<t.length&&(l=t.charCodeAt(n++),l===r);)o++;return o<3?!1:(b(t.charCodeAt(n-1))||n--,d(e,"end")(t))}},{shift:2,type:"paragraph_close"}],transform:(t,n,l,r)=>{const o=t[n],s=t[n+1],{content:i}=s;o.type="hr",o.tag="hr",o.nesting=0,p(o,i,r,e.allowed),o.markup=i,t.splice(n+1,2)}}),C=e=>{e.hidden=!0,e.children?.forEach(t=>{t.content="",C(t)})},G=(e,t,n,l,r,o)=>{let s=l-(r>0?r:1);for(let i=t,c=o;i<n&&c>1;i++)if(e[i].type==="tr_open"){const a=e[i];a.meta??={},a.meta.columnCount&&(s-=1),a.meta.columnCount=s,c--}},H=(e,t,n)=>{const l=e[t].meta?.columnCount;if(l)for(let r=t,o=0;r<n;r++){const s=e[r];if(s.type==="tr_close")break;s.type==="td_open"&&(o+=1),o>l&&!s.hidden&&C(s)}},J=(e,t,n,l,r,o)=>{const s=[],i=e[t];let c=t+3,a=l;for(let f=t;f>o;f--)if(e[f].type==="tr_open"){a=e[f].meta?.columnCount??a;break}else e[f].type==="td_open"&&s.unshift(f);for(let f=t+2;f<n;f++)if(e[f].type==="tr_close"){c=f;break}else e[f].type==="td_open"&&s.push(f);const h=s.indexOf(t),u=Math.min(r,a-h);r>u&&i.attrSet("colspan",u.toString());const y=s.slice(a+1-l-u)[0];for(let f=y;f<c;f++)e[f].hidden||C(e[f])},L=e=>[{name:"table",tests:[{shift:0,type:"table_close"},{shift:1,type:"paragraph_open"},{shift:2,type:"inline",content:d(e,"only")}],transform:(t,n,l,r)=>{const o=t[n+2],s=g(t,n);p(s,o.content,r,e.allowed),t.splice(n+1,3)}},{name:"table cell attributes",tests:[{shift:-1,type:t=>t==="td_open"||t==="th_open"},{shift:0,type:"inline",children:[{shift:0,type:"text",content:d(e,"end")}]}],transform:(t,n,l,r)=>{const o=r[0]-e.left.length,s=t[n].children[l],i=t[n-1],{content:c}=s,a=b(c.charCodeAt(o-1));p(i,c,r,e.allowed),s.content=c.slice(0,a?o-1:o)}},{name:"table thead metadata",tests:[{shift:0,type:"tr_close"},{shift:1,type:"thead_close"},{shift:2,type:"tbody_open"}],transform:(t,n)=>{const l=g(t,n),r=t[n-1];let o=0,s=n-1;for(;s>0;){const c=t[s];if(c===l){const a=t[s-1];a.meta={...a.meta,columnCount:o};break}c.level===r.level&&c.type===r.type&&o++,s--}const i=t[n+2];i.meta={...i.meta,columnCount:o}}},{name:"table tbody calculate",tests:[{shift:0,type:"tbody_close",hidden:!1}],transform:(t,n)=>{let l=n-2;for(;l>0&&(l--,t[l].type!=="tbody_open"););const r=t[l].meta?.columnCount??0;if(r<2)return;const o=t[n].level+2;for(let s=l;s<n;s++){if(t[s].level>o)continue;const i=t[s],c=i.hidden?0:Number(i.attrGet("rowspan")),a=i.hidden?0:Number(i.attrGet("colspan"));c>1&&G(t,s,n,r,a,c),i.type==="tr_open"&&H(t,s,n),a>1&&J(t,s,n,r,a,l)}}}],x=["fence","inline","table","list","heading","hr","softbreak","block"],N=e=>{const t=e.rule===!1?[]:Array.isArray(e.rule)?e.rule.filter(l=>x.includes(l)):x,n=[];return t.includes("fence")&&n.push(M(e)),t.includes("inline")&&n.push(...P(e)),t.includes("table")&&n.push(...L(e)),t.includes("list")&&n.push(...W(e)),t.includes("softbreak")&&n.push(B(e)),t.includes("hr")&&n.push(D(e)),t.includes("block")?n.push(I(e)):t.includes("heading")&&n.push(K(e)),n},U=(e,{left:t="{",right:n="}",allowed:l=[],rule:r="all"}={})=>{const o=N({left:t,right:n,allowed:l,rule:r}),s=({tokens:i})=>{for(let c=0;c<i.length;c++)for(let a=0;a<o.length;a++){const h=o[a];let u=null,y=null;h.tests.every(f=>{const m=A(i,c,f);return m.position!==null&&({position:u}=m),m.range&&(y=m.range),m.match})&&(h.transform(i,c,u,y),(h.name==="inline attributes"||h.name==="inline nesting self-close")&&a--)}};e.core.ruler.before("linkify","attrs",s)};export{U as attrs};
//# sourceMappingURL=index.js.map
